<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_immo_bill_invoice_form" model="ir.ui.view">
        <field name="name">immo_bill.invoice.form</field>
        <field name="model">immo_bill.invoice</field>
        <field name="arch" type="xml">
            <form string="Chantier">
                <header>
                    <button name="synchro_data_saleorder" string="Synchro" type="object"
                            class="oe_highlight"/>
                    <button name="rg_generate_invoice" string="Generer Facture de retenue" type="object" class="oe_highlight" attrs="{'invisible': ['|',('retenue_percent', '=', 0),('rg_invoice_id', '!=', False)]}"/>
                    <!-- <button name="action_draft" states="done" string="Set To Draft"
                            type="object"/>
                    <field name="state" widget="statusbar"/> -->
                    <!-- <button name="action_update_status" string="Update situation" type="object"/> -->
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="open_invoice" type="object" class="oe_stat_button" icon="fa-pencil-square-o" attrs="{'invisible': [('invoices_ids', '=', [])]}">
                            <field name="count_invoice" widget="statinfo" string="Factures"/>
                        </button>
                        <button name="open_situation" type="object" class="oe_stat_button" icon="fa-handshake-o" attrs="{'invisible': [('situation_ids', '=', [])]}">
                            <field name="count_situation" widget="statinfo" string="Situations"/>
                        </button>
                    </div>
                    <h1>
                        <label for="name" />
                        <div class="d-flex w-100">
                            <field name="name" attrs="{'invisible': [('name','=', False)]}"/>
                        </div>
                    </h1>
                    <group string="Retenue de garantie">
                        <group>
                            <field name="retenue_percent" string="Taux" widget="percentage"/>
                        </group>
                        <group>
                            <field name="rg_sale_mode" string="Mode"/>
                        </group>
                    </group>
                    <group string="Evolution">
                        <group>
                            <field name="partner_id"/>
                            <field name="sale_order_id" />
                            <field name="avenant_ids" domain="[('id', '!=', sale_order_id), ('partner_id', '=', partner_id)]" widget="many2many_tags" attrs="{'invisible': [('sale_order_id', '=', False)]}" />
                            <!-- <field name="avenant_ids" domain="[('id', '!=', sale_order_id), '|', ('immo_bill_ids', '=', []), ('immo_bill_ids', 'child_of', [sale_order_id])]" widget="many2many_tags" attrs="{'invisible': [('sale_order_id', '=', False)]}" /> -->
                            <!-- <field name="payment_type"/>
                            <field name="amount" widget="monetary"/>
                            <field name="journal_id" domain="[('type', 'in', ('bank', 'cash'))]"/> -->
                        </group>
                        <group>
                            <field name="avancement_montant" />
                            <field name="current_progress" widget="percentage" />
                            <field name="building_progress" widget="percentage" invisible="1"/>
                            <field name="amount_total" />
                            <field name="uninvoiced_amount" />
                            <field name="rg_amount_untaxed_total" attrs="{'invisible': ['|',('retenue_percent', '=', 0),('rg_sale_mode','=','ttc')]}"/>
                            <field name="rg_amount_total" attrs="{'invisible': ['|',('retenue_percent', '=', 0),('rg_sale_mode','=','ht')]}"/>
                            <field name="rg_cumul_unt_amount" attrs="{'invisible': ['|',('retenue_percent', '=', 0),('rg_sale_mode','=','ttc')]}" />
                            <field name="rg_cumul_amount" attrs="{'invisible': ['|',('retenue_percent', '=', 0),('rg_sale_mode','=','ht')]}" />
                            <field name="currency_id" invisible="1" />
                            <!-- <field name="date_begin" widget="daterange"
                                   options="{'related_end_date': 'date_end'}"/>
                            <field name="date_end" widget="daterange"
                                   options="{'related_start_date': 'date_begin'}"/>
                            <field name="recurring_period"/>
                            <field name="recurring_interval"/>
                            <field name="journal_state"/> -->
                        </group>
                    </group>
                    <notebook>
                        <page string="Lines">
                            <field name="line_ids" widget="section_and_note_one2many">
                                <tree editable="top">
                                    <field name="sequence" string="N" widget="handle" />
                                    <field name="product_id" readonly="1"/>
                                    <field name="name" readonly="1"/>
                                    <field name="quantity" readonly="1"/>
                                    <field name="uom_id" readonly="1"/>
                                    <field name="price_unit" widget="monetary" readonly="1"/>
                                    <field name="total_ht" readonly="1" sum="Total HT"/>
                                    <field name="vat" widget="monetary" readonly="1" sum="Total VAT"/>
                                    <field name="total_ttc" readonly="1" invisible="0" sum="Total TTC"/>
                                    <field name="progress" attrs="{'column_invisible': [('parent.avancement_montant', '=', True)]}" widget="percentage"/>
                                    <field name="ro_progress" attrs="{'column_invisible': [('parent.avancement_montant', '=', False)]}" widget="percentage"/>
                                    <field name="total_progress" sum="Total" invisible="1"/>
                                    <field name="untaxed_total_progress" attrs="{'column_invisible': [('parent.avancement_montant', '=', False)]}" sum="Total progress ht"/>
                                    <field name="ro_untaxed_total_progress" attrs="{'column_invisible': [('parent.avancement_montant', '=', True)]}" sum="Total"/>
                                    <field name="currency_id" invisible="1"/>
                                    <field name="invoice_id" invisible="1"/>
                                    <field name="sale_order_line_id" invisible="1"/>
                                    <field name="from_avenant" invisible="1"/>
                                    <field name="display_type" invisible="1"/>
                                </tree>
                            </field>

                        </page>
                        <page string="Acomptes">
                            <field name="pre_payment_ids" widget="section_and_note_one2many">
                                <tree editable="top" create="0" delete="0" edit="0">
                                    <field name="sequence" string="N" widget="handle" readonly="1"/>
                                    <field name="product_id" readonly="1" invisible="1" />
                                    <field name="name" readonly="1"/>
                                    <field name="quantity" readonly="1" invisible="1" />
                                    <field name="uom_id" readonly="1" invisible="1" />
                                    <field name="price_unit" string="Montant" widget="monetary" readonly="1" invisible="1" />
                                    <field name="total_ht" readonly="1" sum="Total HT" invisible="1" />
                                    <field name="vat" widget="monetary" readonly="1" sum="Total VAT" invisible="1" />
                                    <field name="total_ttc" string="Montant" readonly="1" sum="Total TTC" invisible="0"  />
                                    <field name="progress" widget="percentage" invisible="1" />
                                    <field name="total_progress" sum="Total" invisible="1" />
                                    <field name="situation_id" />
                                    <field name="currency_id" invisible="1" />
                                    <field name="invoice_id" invisible="1" />
                                    <field name="sale_order_line_id" invisible="1" />
                                    <field name="display_type" invisible="1" />
                                </tree>
                            </field>
                        </page>
                        <page string="Situations">
                            <field name="situation_ids">
                                <tree create="0" delete="1" edit="1" editable="bottom" decoration-success="state == 'invoiced'">
                                    <field name="name" readonly="1"/>
                                    <field name="situation_order" readonly="1"/>
                                    <field name="situation_progress" widget="percentage" sum="Total" readonly="1"/>
                                    <field name="immo_bill_id" invisible="1"/>
                                    <field name="date_confirmation" readonly="1"/>
                                    <field name="untaxed_amount" sum="Total HT" readonly="1"/>
                                    <field name="amount_down_payment" sum="Total down payment" readonly="0" attrs="{'column_invisible': [('parent.pre_payment_ids', '=', [])]}"/>
                                    <field name="amount_total" sum="Total" readonly="1"/>
                                    <field name="invoices_ids" invisible="1"/>
                                    <field name="state" invisible="1"/>
                                    <button name="action_confirm" type="object" string="Confirm"/>
                                    <button name="open_invoice" type="object" string="Invoice"/>
                                </tree>
                            </field>
                        </page>
                        <page string="factures" invisible="1">
                            <field name="invoices_ids" invisible="1" />
                        </page>
                        <page string="Autres Informations">
                            <group>
                                <group string="Devis">
                                    <field name="rg_date_expiration" attrs="{'invisible': [('retenue_percent', '=', 0)]}"/>
                                    <field name="rg_invoice_id" readonly="1" attrs="{'invisible': [('rg_invoice_id', '=', False)]}"/>
                                </group>
                                <group></group>
                            </group>
                        </page>

                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_immo_bill_invoice_tree" model="ir.ui.view">
        <field name="name">immo_bill.invoice.tree</field>
        <field name="model">immo_bill.invoice</field>
        <field name="arch" type="xml">
            <tree string="Chantier">
                <field name="name" invisible="1"/>
                <field name="partner_id"/>
                <field name="sale_order_id"/>
                <field name="amount_total"/>
                <field name="current_progress" widget="percentage"/>
            </tree>
        </field>
    </record>

    <record id="view_immo_bill_invoice_search" model="ir.ui.view">
        <field name="name">immo_bill.invoice.search</field>
        <field name="model">immo_bill.invoice</field>
        <field name="arch" type="xml">
            <search string="Recherche chantier">
                <field name="name"/>
            </search>
        </field>
    </record>

    <record id="action_immo_bill_invoice" model="ir.actions.act_window">
        <field name="name">Chantier</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">immo_bill.invoice</field>
        <field name="view_mode">tree,form</field>
    </record>

    <menuitem id="menu_immo_bill_invoice"
              name="Chantier"
              sequence="10"
              action="action_immo_bill_invoice"
              groups=""
              parent="immo_bill.main_menu"/>

</odoo>